#!/usr/bin/env bash
# bin/compile build_path cache_path
build="$1"
cache="$2"
set -e
mkdir -p "${cache}/clamav-data"
# freshclam is located like here: /tmp/build_ca3d3744f602b444e071dbaf54f30d3f/.apt/usr/bin/freshclam
# we need to create /tmp/build_ca3d3744f602b444e071dbaf54f30d3f/clamav/freshclam.conf
CLAM_DIR=$(dirname $(dirname $(dirname $(dirname $(which freshclam)))))
echo $CLAM_DIR
echo ${build}
ls -l $CLAM_DIR
mkdir $CLAM_DIR/clamav
echo 'DatabaseMirror database.clamav.net' > $CLAM_DIR/clamav/freshclam.conf
# Hack to eliminate missing library error. libjson-c.so.2.0.0 is loaded in the wrong place
LD_LIBRARY_PATH="$LD_LIBRARY_PATH$(dirname $(find /tmp/ -name libjson-c.so.2.0.0)):"
# Override the specified datadir so we retain changes via the cache.
freshclam --config-file="${build}/clamav/freshclam.conf" --datadir="${cache}/clamav-data/" --log=/dev/stdout --quiet
rm -rf "${build}/.clamav-data"
cp -rp "${cache}/clamav-data" "${build}/.clamav-data"
echo "database in ${build}/.clamav-data:"
ls -l "${build}/.clamav-data"
